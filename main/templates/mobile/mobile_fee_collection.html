{% extends 'mobile/mobilebase.html' %}
{% load static %}
{% block content %}

<div class="container-fluid g-0">
    <div class="row mt-3">
        <div class="col-12">
            <div class="bg-white pd-10 br-30 shadow">
                <div class="row f-12">
                    <div class="col-4 pe-0 my-auto">
                        <div class="custom_dropdown">
                            <input type="text" data-id="" value="All Batches" id="batchfilter"
                                class="class search_input shadow br-30 form-control f-12 OP EXC"
                                placeholder="Batch..." />
                            <div class="optionblock">
                                <div class="option_item" data-fun="load_data" data-id="">All Batches</div>
                                {% for b in batches %}
                                <div class="option_item" data-fun="load_data" data-id="{{ b.id }}">{{b.Title}}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col my-auto">
                        <input type="text" placeholder="Search..." id="search" class="form-control br-30 shadow f-12" />
                    </div>
                    <div class="col-2 text-center my-auto ps-0">
                        <div class="bg-green br-30 shadow" style="padding: 5px;" onclick="load_data()">
                            <i class="fas fa-search cl-w f-14 p-n"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row bg-light mt-3 g-0 pdy-20 pdx-10" style="border-radius: 20px 20px 0px 0px;">
        <div class="col-12" id="student_container" style="perspective: 1000px;">
            <table class="table f-12">
                <thead>
                    <tr>
                        <th>Member</th>
                        <th>
                            <div>
                                <span class="p-n">Last Payment</span>
                                <i class="fas fa-filter p-n ps-2" hidden></i>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="main_body">

                </tbody>
            </table>
        </div>
    </div>
</div>

<table hidden>
    <tr id="row_temp">
        <td class="membername" onclick="fee_modal()"></td>
        <td class="lastfee" onclick="fee_modal()"></td>
    </tr>

    <tr id="hist_temp">
        <td class="month"></td>
        <td class="amount"></td>
        <td class="date"></td>
        <td class="f-14">
            <i class="fas fa-eye cl-g me-2" onclick="open_payment_detail()"></i>
            <i class="fas fa-edit cl-b me-2" onclick="start_edit()"></i>
            <i class="fas fa-trash cl-r" onclick="start_delete()"></i>
        </td>
    </tr>
</table>

<!-- Modal -->
<div class="modal fade" id="feeModal" data-id="" tabindex="-1" aria-labelledby="feeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fwb" data-id="" id="feeModalLabel">Fee Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid g-0">
                    <div class="row mb-3 shadow br-10 py-1" style="border: 1px solid gray;">
                        <div class="col-6">
                            <div class="mb-1 f-10">Fee Type</div>
                            <div class="custom_dropdown">
                                <input type="text" data-id="" id="feetype"
                                    class="feetype search_input shadow br-30 form-control f-12"
                                    placeholder="Fee Type..." />
                                <div class="optionblock fee_drop">
                                    {% for type in feetype %}
                                    <div class="option_item" data-id="{{type.id}}">{{type.title}}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-1 f-10">Month-Year</div>
                            <input type="month" class="form-control f-12 br-30 shadow monthyear" id="monthyear"
                                value="{%now 'Y-m'%}" />
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-1 f-10">Amount</div>
                            <input type="number" class="form-control f-12 br-30 shadow amount" id="feeamount"
                                onkeyup="calculate_total()" />
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-1 f-10">Discount</div>
                            <input type="number" class="form-control f-12 br-30 shadow discount" id="feediscount"
                                onkeyup="calculate_total()" />
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-1 f-10">Collection Date</div>
                            <input type="date" value="" class="form-control f-12 br-30 shadow INP" id="collectdate" />
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-1 f-10">Payment Mode</div>
                            <div class="custom_dropdown">
                                <input type="text" data-id="" id="mode"
                                    class="class search_input shadow br-30 form-control f-12 OP"
                                    placeholder="Payment Mode..." />
                                <div class="optionblock" id="mode_drop">
                                    {% for mode in modes %}
                                    <div class="option_item" data-id="{{ mode.id }}">{{ mode.title }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-1 f-10">Referenece No</div>
                            <input type="text" class="form-control f-12 br-30 shadow INP" id="refno" />
                        </div>
                        <div class="col-6 mb-10">
                            <div class="mb-2 f-10">Net Amount</div>
                            <div class="fwb total" id="totalamount">INR 0.00</div>
                        </div>
                        <div class="col-8 mb-10">
                            <div class="mb-1 f-10">Remarks</div>
                            <textarea rows="2" type="text" class="form-control f-12 br-10 shadow INP"
                                id="remarks"></textarea>
                        </div>
                        <div class="mt-auto col-4 text-end">
                            <div class="mybtn shadow mb-10 br-30 blue f-12" onclick="submit_data()">Save</div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <table class="table f-12">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Amount</th>
                                        <th>Payment Date</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="feebody">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailModalLabel">Payment Detail</h5>
            </div>
            <div class="modal-body">
                <div class="container-fluid f-12 g-0">
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Month</div>
                        <div class="col-8" id="detailmonth"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Amount</div>
                        <div class="col-8" id="detailamount"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Discount</div>
                        <div class="col-8" id="detaildiscount"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Total</div>
                        <div class="col-8" id="detailtotal"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Payment Date</div>
                        <div class="col-8" id="detaildate"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Type</div>
                        <div class="col-8" id="detailtype"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Mode</div>
                        <div class="col-8" id="detailmode"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Referenece No</div>
                        <div class="col-8" id="detailref"></div>
                    </div>
                    <div class="row mb-10">
                        <div class="col-4 cl-b">Remarks</div>
                        <div class="col-8" id="detailremarks"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="close_detail()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Payment Month</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid g-0">
                    <div class="row mb-10">
                        <div class="col-4 cl-b my-auto" >Month</div>
                        <div class="col-8">
                            <input type="month" id="filtermonth" class="form-control f-12"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="clear_month()">Clear</button>
                <button type="button" class="btn btn-success" onclick="apply_month()">Apply</button>
            </div>
        </div>
    </div>
</div>

<script>
    function open_filter(){
        $("#filterModal").modal("show");
    }

    function clear_month(){
        $("#filtermonth").val("");
    }

    function apply_month(){
        $("#filterModal").modal("hide");
        load_data();
    }

    var delid = "";
    function start_delete() {
        delid = event.target.parentElement.parentElement.getAttribute("data-feeid");
        $("#feeModal").modal("hide");
        $("#detailModal").modal("hide");
        ask_confirm("Are you sure you want to delete this fee collection?", "delete_fee", "cancel_delete");
    }

    function cancel_delete() {
        memcard.getElementsByClassName("membername")[0].click();
        hide_confirm();
    }

    function delete_fee() {
        console.log(delid);
        delete_item(delid, "Fee");
        hide_confirm();
        load_data();
        memcard.getElementsByClassName("membername")[0].click();
    }

    function start_edit() {
        var parent = event.target.parentElement.parentElement;
        var feeid = parent.getAttribute("data-id");
        $("#feeModalLabel").attr("data-id", parent.getAttribute("data-feeid"));
        var fdata = new FormData();
        fdata.append("itemid", feeid);
        var detail = load_ajax_data("/get_fee_item_detail", fdata);
        console.log(detail);
        if (detail.length > 0) {
            detail = detail[0];

            $("#feetype").attr("data-id", detail["type"]);
            $("#feeamount").val(detail["amount"]);
            $("#collectdate").val(detail["documentdate"]);
            $("#feediscount").val(detail["discount"]);
            $("#monthyear").val(detail["monthyear"]);
            $("#refno").val(detail["referenceno"]);
            $("#mode").attr("data-id", detail["mode"]);
            $("#totalamount").html(INR + " " + add_commas(detail["totalamount"]));
            $("#totalamount").attr("data-value", detail["totalamount"]);
            $("#remarks").val(detail["remarks"]);

            set_drop_default();
        }
    }

    function submit_data() {
        var feeid = $("#feeModalLabel").attr("data-id");
        var studentcode = $("#feeModal").attr("data-id");
        var collectdate = $("#collectdate").val();
        var mode = $("#mode").attr("data-id");
        var refno = $("#refno").val().trim();
        var remarks = $("#remarks").val().trim();

        var totalamount = $("#totalamount").attr("data-value");

        var data = new FormData();
        if (feeid != "") {
            data.append("feeid", feeid);
        }
        data.append("student", studentcode);
        data.append("collectdate", collectdate);
        data.append("mode", mode);
        data.append("refno", refno);
        data.append("remarks", remarks);
        data.append("total", totalamount);
        //items
        var rows = document.getElementsByClassName("payrow");
        var datastring = "";

        datastring += $("#feetype").attr("data-id") + "^";
        datastring += $("#monthyear").val() + "^";

        var amt = parseFloat($("#feeamount").val().trim());
        if (isNaN(amt)) {
            amt = 0;
        }

        var dis = parseFloat($("#feediscount").val().trim());
        if (isNaN(dis)) {
            dis = 0;
        }

        var tl = totalamount

        datastring += amt + "^";
        datastring += dis + "^";
        datastring += "0" + "^";
        datastring += tl + "^";
        datastring += "#";

        data.append("datastring", datastring);
        data.append("type", "M");
        var code = send_ajax_data("save_fee", data);

        show_toast("Fee Collected", "success");
        load_data();
        $("#feeModalLabel").attr("data-id", "");
        $("#feeModal").find("input").val("");
        $("#feeModal").find("textarea").val("");
        $("#feeModal").find("input").attr("data-id", "");
        $("#totalamount").html("INR 0.00");
        memcard.getElementsByClassName("membername")[0].click();
    }

    function calculate_total() {
        var parent = event.target.parentElement.parentElement;
        var amount = parseFloat(parent.getElementsByClassName("amount")[0].value);
        if (isNaN(amount)) {
            amount = 0;
        }
        var discount = parseFloat(parent.getElementsByClassName("discount")[0].value);
        if (isNaN(discount)) {
            discount = 0;
        }

        var total = amount - discount;

        parent.getElementsByClassName("total")[0].setAttribute("data-value", total);
        parent.getElementsByClassName("total")[0].innerHTML = INR + " " + add_commas(total.toFixed(2));
    }

    var memcard = null;
    function fee_modal() {
        var parent = event.target.parentElement;
        memcard = parent;
        var name = parent.getElementsByClassName("membername")[0].innerHTML;
        var code = parent.getAttribute("data-id");
        $("#feeModal").attr("data-id", code);
        $("#feeModalLabel").html(name);
        $("#detailModalLabel").html(name);
        var data = new FormData();
        data.append("membercode", code);
        var list = load_ajax_data("/member_payment_record", data);

        var feebody = document.getElementById("feebody");
        var feetemp = document.getElementById("hist_temp");
        feebody.innerHTML = "";
        for (var i = 0; i < list.length; i++) {
            var tr = clean_temp(feetemp);

            var monthyear = list[i]["monthyear"].split("-")

            if (monthyear.length > 1) {
                var year = monthyear[0];
                var month = parseInt(monthyear[1]);
                tr.getElementsByClassName("month")[0].innerHTML = monthnames[month - 1] + "-" + year;
            }
            tr.getElementsByClassName("amount")[0].innerHTML = INR + " " + add_commas(list[i]["totalamount"]);
            tr.getElementsByClassName("date")[0].innerHTML = format_date(list[i]["documentdate"]);

            tr.setAttribute("data-feeid", list[i]["feeid"]);
            feebody.appendChild(tr);
            tr.setAttribute("data-id", list[i]["id"]);
        }

        $("#feeModal").find("input").val("");
        $("#feeModal").find("input").attr("data-id", "");
        $("#totalamount").html("INR 0.00");

        $("#feeModal").modal("show");
    }

    function open_payment_detail() {
        var parent = event.target.parentElement.parentElement;
        var feeid = parent.getAttribute("data-id")
        var fdata = new FormData();
        fdata.append("itemid", feeid);
        var detail = load_ajax_data("/get_fee_item_detail", fdata);

        if (detail.length > 0) {
            detail = detail[0];

            $("#detailmonth").html(detail["monthyear"]);
            $("#detailamount").html(INR + " " + add_commas(detail["amount"]));
            $("#detaildiscount").html(INR + " " + add_commas(detail["discount"]));
            $("#detailtotal").html(INR + " " + add_commas(detail["totalamount"]));
            $("#detaildate").html(format_date(detail["documentdate"]));
            $("#detailtype").html(detail["typetitle"]);
            $("#detailmode").html(detail["modetitle"]);
            $("#detailref").html(detail["referenceno"]);
            $("#detailremarks").html(detail["remarks"]);
        }

        $("#feeModal").modal("hide");
        $("#detailModal").modal("show");
    }

    function close_detail() {
        $("#feeModal").modal("show");
        $("#detailModal").modal("hide");
    }
</script>

<script>
    var monthnames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    function load_data() {
        //var filtermonth = $("#filtermonth").val();
        var batch = $("#batchfilter").attr("data-id");
        var search = $("#search").val().trim();
        var data = new FormData();
        data.append("search", search);
        data.append("batch", batch);
        data.append("filtermonth", filtermonth);
        var list = load_ajax_data("get_member_fee_list", data);

        var parent = document.getElementById("main_body");
        var temp = document.getElementById("row_temp");

        parent.innerHTML = "";
        for (var i = 0; i < list.length; i++) {
            var clone = clean_temp(temp);

            parent.appendChild(clone);

            clone.setAttribute("data-id", list[i]["membercode"]);
            clone.getElementsByClassName("membername")[0].innerHTML = list[i]["fullname"];

            var lastfee = list[i]["lastfee"].split("-")

            if (lastfee.length > 1) {
                var year = lastfee[0];
                var month = parseInt(lastfee[1]);

                clone.getElementsByClassName("lastfee")[0].innerHTML = monthnames[month - 1] + "-" + year;
            }
        }
    }


    $(window).on("load", function () {
        load_data();
    })
</script>

{% endblock %}