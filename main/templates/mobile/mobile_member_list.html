{% extends 'mobile/mobilebase.html' %}
{% load static %}
{% block content %}

<style>
    tr.sunday {
        background-color: var(--my_blue);
        color: white;
    }

    tr.absent {
        background-color: var(--my_red);
        color: white;
    }
</style>

<div class="container-fluid g-0">
    <div class="row mt-3">
        <div class="col-12">
            <div class="bg-white pd-10 br-30 shadow">
                <div class="row f-12" data-id="F" id="type">
                    <div class="my-auto col-5">
                        <div class="custom_dropdown">
                            <input type="text" data-id="" value="All Batches"
                                class="search_input form-control f-12 br-30 shadow OP" placeholder="Class..."
                                id="batchfilter" />
                            <div class="optionblock">
                                <div class="option_item" data-fun="load_data" data-id="">All Batches</div>
                                {% for c in batches %}
                                <div class="option_item" data-fun="load_data" data-id="{{c.id}}">{{c.Title}}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="col my-auto ps-0">
                        <input type="text" placeholder="Search..." id="search" class="form-control br-30 shadow f-12" />
                    </div>
                    <div class="col-2 text-center my-auto ps-0">
                        <div class="bg-green br-30 shadow" style="padding: 5px;" onclick="load_data()">
                            <i class="fas fa-search cl-w f-14 p-n"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row bg-light mt-3 g-0 pdy-20 pdx-10" style="border-radius: 20px 20px 0px 0px;">
        <div class="col-12" id="student_container" style="perspective: 1000px;">
            <table class="table f-12">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Photo</th>
                        <th>Name</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="main_body">

                </tbody>
            </table>
        </div>
    </div>
</div>

<table hidden>
    <tr id="main_temp" style="vertical-align: middle;">
        <th class="count">1</th>
        <td>
            <img src="{% static 'img/defaultuser.jpg' %}" alt="Picture" class="faculty_pic_mobile shadow p-n">
        </td>
        <td>
            <div class="fwb f-16 name p-n"></div>
            <div class="row">
                <div class="col-6 code fwb" style="border-right: 1px solid gray;"></div>
                <div class="col-6 subject"></div>
            </div>
        </td>
        <th class="text-center">
            <i class="fas fa-edit shadow icon_btn_sm bg-blue" onclick="edit_student()" data-id=""></i>
        </th>
    </tr>
</table>

<!-- Modal -->
<div class="modal fade" id="studentModal" data-id="" tabindex="-1" aria-labelledby="studentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fwb" id="studentModalLabel">Add Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid g-0">
                    <div class="row">
                        <div class="col-4 mb-3">
                            <div style="position: relative;height: 100%;padding-right: 100%;">
                                <input type="file" id="photofile" hidden accept="image/png, image/jpeg, image/jpg"
                                    onchange="set_profile()" />
                                <img src="{% static 'img/defaultuser.jpg' %}" onclick="click_profie()"
                                    class="add_photo shadow" id="profilepic" style="object-position: center;" />
                            </div>
                        </div>
                        <div class="col-8">
                            <div class="row">
                                <div class="col-12 mb-4">
                                    <div class="mb-1 f-10">Full Name</div>
                                    <input type="text" class="form-control f-12 br-30 shadow INP"
                                        placeholder="Full Name..." id="fullname" />
                                </div>
                                <div class="col-12 mb-4">
                                    <div class="mb-1 f-10">Email ID</div>
                                    <input type="email" class="form-control f-12 br-30 shadow INP"
                                        placeholder="Email ID..." id="email" />
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="row">
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Mobile</div>
                                    <input type="tel" class="form-control f-12 br-30 shadow INP" placeholder="Mobile..."
                                        id="mobile" />
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Whatsapp</div>
                                    <input type="tel" class="form-control f-12 br-30 shadow INP"
                                        placeholder="Whatsapp..." id="whatsapp" />
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Gender</div>
                                    <div data-id="" id="gender" class="OP">
                                        <div class="opbtn me-2 shadow" data-id="M">Male</div>
                                        <div class="opbtn shadow" data-id="F">Female</div>
                                    </div>
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Batch</div>
                                    <div class="custom_dropdown">
                                        <input type="text" data-id="" id="batch"
                                            class="search_input shadow br-30 form-control f-12 OP"
                                            placeholder="Batch..." />
                                        <div class="optionblock">
                                            {% for b in batches %}
                                            <div class="option_item" data-id="{{b.id}}">
                                                {{b.Title}}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Aadhar No</div>
                                    <input type="text" class="form-control f-12 br-30 shadow INP"
                                        placeholder="Aadhar No." id="aadhar" />
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Joining Date</div>
                                    <input type="date" class="form-control f-12 br-30 shadow INP" id="joiningdate" />
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Monthly Fee</div>
                                    <input type="number" class="form-control f-12 br-30 shadow INP" id="monthlyfee"
                                        value="{{request.session.generalfee}}" />
                                </div>
                                <div class="col-6 mb-4">
                                    <div class="mb-1 f-10">Login Password</div>
                                    <input type="text" class="form-control f-12 br-30 shadow INP" id="loginpassword"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger f-12" id="block_btn" onclick="block_member()">Block</button>
                <button type="button" class="btn btn-primary f-12" onclick="archive_member()">Archive</button>
                <button type="button" class="btn btn-secondary f-12" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success f-12" onclick="submit_data()">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="archiveModalLabel">Archive Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div>Leaving Date</div>
                <input type="date" id="leavedate" value="{% now 'Y-m-d' %}" class="form-control f-12 mt-2">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="archive()">Archive</button>
            </div>
        </div>
    </div>
</div>

<i class="uni_add_btn text-center shadow fas fa-plus" onclick="studentModal()"></i>

<script>
    function block_member(){
        var code = $("#studentModalLabel").attr("data-id");
        var data = new FormData();
        data.append("userid", code);
        send_ajax_data("/block_unblock_user", data);
        if(event.target.innerHTML == "Block"){
            event.target.innerHTML = "Unblock";
            show_toast("User blocked", "success");
        }else{
            event.target.innerHTML = "Block";
            show_toast("User unblocked", "success");
        }
    }

    function archive_member(){
        $("#studentModal").modal("hide");
        $("#archiveModal").modal("show");
    }

    function archive() {
        var id = $("#studentModalLabel").attr("data-id");
        var leavedate = $("#leavedate").val();
        var data = new FormData();
        data.append("membercode", id);
        data.append("status", "C");
        data.append("leavingdate", leavedate);
        send_ajax_data("change_member_status", data);
        load_data();
        $("#archiveModal").modal("hide");
        show_toast("Member Archived", "success");
    }

    function edit_student() {
        var parent = event.target.parentElement.parentElement;
        var id = parent.getAttribute("data-id");
        var tabid = parent.getAttribute("data-tabid");
        $("#studentModalLabel").html("Edit Member : " + id);
        $("#studentModalLabel").attr("data-id", id);
        $("#studentModalLabel").attr("data-tabid", tabid);

        var data = new FormData();
        data.append("membercode", id);
        var detail = load_ajax_data("get_member_detail", data);
        detail = detail.data;

        $("#fullname").val(detail["fullname"]);
        $("#email").val(detail["email"]);
        $("#mobile").val(detail["mobile"]);
        $("#whatsapp").val(detail["whatsapp"]);
        $("#gender").attr("data-id", detail["gender"]);
        $("#joiningdate").val(detail["joiningdate"]);
        $("#monthlyfee").val(detail["monthlyfee"]);
        $("#batch").attr("data-id", detail["batchid"]);
        $("#aadhar").val(detail["aadharno"]);
        $("#loginpassword").val(detail["loginpassword"]);
        
        if (detail["picture"] != "") {
            document.getElementById("profilepic").src = "/static/uploads/" + detail["picture"];
            document.getElementById("photofile").classList.add("old");
            //url_to_file("/static/uploads/" + detail["picture"], document.getElementById("photofile"));
        }

        if(detail["blocked"] == false){
            $("#block_btn").html("Block");
        }else{
            $("#block_btn").html("Unblock");
        }

        $("#deletebtn").attr("hidden", false);

        var status = $(".pagestatus.active").eq(0).attr("data-status-id");
        if (status == "A") {
            $("#archivebtn").attr("hidden", false);
            $("#unarchivebtn").attr("hidden", true);
        } else {
            $("#archivebtn").attr("hidden", true);
            $("#unarchivebtn").attr("hidden", false);
        }

        set_drop_default();
        $("#studentModal").modal("show");
    }

    function submit_data() {
        var membercode = $("#studentModalLabel").attr("data-id");
        var ops = document.getElementsByClassName("OP");
        var inps = document.getElementsByClassName("INP");

        var data = new FormData();
        if (membercode != "") {
            data.append("membercode", membercode);
        }

        for (var i = 0; i < ops.length; i++) {
            data.append(ops[i].id, ops[i].getAttribute("data-id"));
        }
        for (var i = 0; i < inps.length; i++) {
            if (inps[i].value != "") {
                data.append(inps[i].id, inps[i].value);
            }
        }

        var photo = document.getElementById("photofile").files;
        if (photo.length > 0 && !document.getElementById("photofile").classList.contains("old")) {
            photo = photo[0];
            var filename = save_file(photo);
            filename = filename.name;
            data.append("photo", filename);
        }

        var code = send_ajax_data("save_member", data);

        if (membercode == "") {
            var message = "New member created with code " + code.code;
            success_modal(message);
        } else {
            var message = "Member with code " + code.code + " updated";
            success_modal(message);
        }

        save_user();

        load_data();
        $("#studentModal").modal("hide");
    }

    function save_user(){
        var pass = $("#loginpassword").val().trim();
        var newid = $("#studentModalLabel").attr("data-id");

        var data = new FormData();
        data.append("userid", newid);
        data.append("password", pass);
        send_ajax_data("update_member_user", data);
    }

    function studentModal() {
        $("#profilepic").attr("src", "{% static 'img/defaultuser.jpg' %}");
        $("#studentModal").find(".opbtn").removeClass("active");
        $("#studentModal").find("input").val("");
        $("#studentModal").find("input").attr("data-id", "");
        $("#studentModal").modal("show");
    }

    function click_profie() {
        document.getElementById("photofile").click();
    }

    function set_profile() {
        var files = document.getElementById("photofile").files;
        if (files.length > 0) {
            files = files[0];
            compressImage(files, 500, 500, 80, function (dataURL) {
                // Convert the compressed image data URL to a file object
                var newname = "compimage." + files.name.split(".").pop();
                var compressedFile = dataURLtoFile(dataURL, newname);
                document.getElementById("profilepic").src = URL.createObjectURL(compressedFile);
                var dt = new DataTransfer();
                dt.items.add(compressedFile);
                document.getElementById("photofile").files = dt.files;
                document.getElementById("photofile").classList.remove("old");
            });
        }
    }
</script>

<script>
    function make_call() {
        var id = event.target.getAttribute("data-id");
        if (id != "") {
            window.open("tel:" + id);
        }
    }

    function open_profile() {
        var id = event.target.getAttribute("data-id");
        window.open("member_profile/" + id, "_self");
    }

    function load_data() {
        var data = new FormData();
        var search = $("#search").val().trim();
        var status = "A";
        var batch = $("#batchfilter").attr("data-id");

        data.append("batch", batch);
        data.append("status", status);
        data.append("search", search);
        var list = load_ajax_data("get_member_list", data);

        var parent = document.getElementById("main_body");
        var temp = document.getElementById("main_temp");

        parent.innerHTML = "";
        for (var i = 0; i < list.length; i++) {
            var clone = clean_temp(temp);
            parent.appendChild(clone);

            $(clone).find("td").attr("data-id", list[i]["membercode"]);
            $(clone).find("td").on("click", function () {
                open_profile();
            })
            clone.setAttribute("data-id", list[i]["membercode"]);
            $(clone).find(".count").eq(0).html(i + 1);
            $(clone).find(".name").html(list[i]["fullname"]);
            $(clone).find(".code").html(list[i]["membercode"]);
            $(clone).find(".subject").html(list[i]["batchtitle"]);
            $(clone).find(".mobile").attr("data-id", list[i]["mobile"]);

            if (list[i]["picture"] != "null" && list[i]["picture"] != "") {
                clone.getElementsByClassName("faculty_pic_mobile")[0].src = "/static/uploads/" + list[i]["picture"];
            }
        }

    }

    $(window).on("load", function () {
        load_data();
    })
</script>

{% endblock %}